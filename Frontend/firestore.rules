rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // NOTE: API Endpoints Access
    // Some collections allow read access without authentication
    // for API endpoints like /api/team/websites
    
    // Users collection
    match /users/{userId} {
      // อ่าน-เขียนข้อมูลตัวเองได้
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // ทุกคนที่ล็อกอินแล้วอ่านได้ (สำหรับระบบ)
      allow read: if request.auth != null;
      
      // สร้าง user ใหม่ได้เมื่อล็อกอิน
      allow create: if request.auth != null;
    }
    
    // Usernames collection
    match /usernames/{username} {
      // อ่านได้เพื่อตรวจสอบ username ซ้ำ
      allow read: if true;
      
      // สร้าง-แก้ไข-ลบได้เมื่อล็อกอิน
      allow write: if request.auth != null;
    }
    
    // Teams collection
    match /teams/{teamId} {
      // ทุกคนที่ล็อกอินแล้วอ่าน-เขียนได้
      allow read, write: if request.auth != null;
      
      // อนุญาตให้อ่านข้อมูลสำหรับ API endpoints (ไม่ต้องล็อกอิน)
      allow read: if true;
    }
    
    // Team Members collection
    match /teamMembers/{memberId} {
      // ทุกคนที่ล็อกอินแล้วอ่าน-เขียนได้
      allow read, write: if request.auth != null;
    }
    
    // Team-related collections
    match /teamInvitations/{invitationId} {
      allow read, write: if request.auth != null;
    }
    
    match /invitations/{invitationId} {
      allow read, write: if request.auth != null;
    }
    
    // Websites collection
    match /websites/{websiteId} {
      // ทุกคนที่ล็อกอินแล้วอ่าน-เขียนได้
      allow read, write: if request.auth != null;
      
      // อนุญาตให้อ่านข้อมูลสำหรับ API endpoints (ไม่ต้องล็อกอิน)
      allow read: if true;
    }
    
    // User websites subcollection
    match /users/{userId}/websites/{websiteId} {
      allow read, write: if request.auth != null;
    }
    
    // Topup History - ปลอดภัยและใช้งานได้
    match /topupHistory/{historyId} {
      // ทุกคนที่ล็อกอินแล้วอ่าน-เขียนได้
      allow read, write: if request.auth != null;
    }
    
    // Withdraw History - ปลอดภัยและใช้งานได้
    match /withdrawHistory/{historyId} {
      // ทุกคนที่ล็อกอินแล้วอ่าน-เขียนได้
      allow read, write: if request.auth != null;
    }
    
    // User history subcollections
    match /users/{userId}/topupHistory/{historyId} {
      allow read, write: if request.auth != null;
    }
    
    match /users/{userId}/withdrawHistory/{historyId} {
      allow read, write: if request.auth != null;
    }
    
    // System Logs
    match /systemLogs/{logId} {
      allow read, write: if request.auth != null;
    }
    
    // User profiles
    match /userProfiles/{userId} {
      // ทุกคนที่ล็อกอินแล้วอ่าน-เขียนได้
      allow read, write: if request.auth != null;
    }
    
    // Test collections
    match /__test__/{testId} {
      allow read, write: if true;
    }
    
    // สำหรับความปลอดภัย: collections อื่นๆ ที่ไม่ได้กำหนดจะถูกปฏิเสธ
  }
}